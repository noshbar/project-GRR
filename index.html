<html>
	<head>
		<meta http-equiv="Cache-Control" content="no-cache">
		<meta http-equiv='Content-Type'  content='text/html; charset=utf-8'>
		<link href="arsse.css" rel="stylesheet">
		<!--[if lt IE 7]>
		<style type="text/css" media="screen">
			/* let the IE expressions commence */
			#sidebar
			{
				height: expression(document.body.clientHeight + "px");
			}
			#content
			{
				height: expression(document.body.clientHeight - (100 + 120 + (2 * 5)) + "px");
				width: expression(document.body.clientWidth - (200 + 300 + (2 * 5)) + "px");
			}
		</style>
		<![endif]-->
		<link href="controlPanel.css" rel="stylesheet">

		 <script type="text/javascript" src="jquery-1.9.1.min.js"></script>
		 <script type="text/javascript" src="waypoints.min.js"></script>
		 <script type="text/javascript" src="jquery.idTabs.min.js"></script>
		 <script type="text/javascript"> 

		 	function decreaseCount(siteName)
		 	{
		 		for (var f = 0; f < 2; f++)
		 		{
					var counter = $('#counter' + siteName);
					var count   = counter.attr('unreadCount') - 1;
					counter.attr('unreadCount', count);
					counter.text(' (' + count + ')');
					siteName = 'All';
				}
		 	}

		 	function nextPage()
		 	{
		 		//TODO: show a 'please wait' message here
		 		//TODO: count how many times this has been called. If it's taking longer than e.g., 10 seconds, then stop trying and show an error message
		 		var pending = parseInt($('#content').attr('pendingMarks'));
		 		if (pending > 0)
		 			setTimeout(nextPage, 200);
		 		else
		 			loadItems($('#content').attr('currentSiteId'));
		 	}

		 	function addStatusMessage(message)
		 	{
		 		if (!message)
		 			return;

				var div = $('<div>').html(message);
				div.attr('class', 'statusMessage');
				$('#messages').prepend(div);
		 	}

		 	function decodeJSON(data)
		 	{
		 		if (!data)
		 			return null;

				data = jQuery.parseJSON(data);
				if (!data.error)
					return data;

				addStatusMessage(data.error);
				return null;
		 	}

		 	function itemToDiv(item)
		 	{
				var div      = $("<div>");
				div.attr('class', 'contentItem');
				
				var title    = $("<a>").text(item.siteId + ': ' + item.title);
				title.attr('href', item.source);
				
				var when     = $("<b>").text(item.timestamp + "   ");

				var saveText = $("<sup>").text("[save destination page]");
				var saveLink = $("<a>").text("");
				saveLink.append(saveText);
				saveLink.attr('href', '#');
				saveLink.attr('class', 'saveLink');
				saveLink.attr('itemId', item.itemId);
				saveLink.click( function() {
					var id = parseInt($(this).attr('itemId'));
					$.post("savePage.php",
					{
						itemId: id
					}, function(data) {
						data = decodeJSON(data);
						if (data)
							addStatusMessage(data.message);
					});
				});

				var contents = $("<div>").html(item.contents);

				div.append(when);
				div.append(saveLink);
				div.append($("<br>"));
				div.append(title);
				div.append($("<br>"));
				div.append(contents);
				$("#content").append(div);				

				return div;	 		
		 	}

		    function loadItems(siteId)
		 	{
		 		currentSiteId = $('#content').attr('currentSiteId');
		 		$('#content').empty();

		 		$('#content').attr('currentSiteId', siteId);
		 		lastItemId = $('#counterAll').attr('lastItemId');

				$.post("getItems.php",
				{
					site       : siteId,
					lastId     : lastItemId,
					maxItems   : 10,
				},
				function(data, status) {
					data = decodeJSON(data);
					if (!data || !data.items || !data.items.length)
					{
						var div = $("<div>").text('Nothing to see here.');
						$("#content").append(div);
						return;
					}

					for (var x = 0; x < data.items.length; x++)
					{
						var div      = itemToDiv(data.items[x]);
						$("#content").append(div);

						var hr       = $("<hr>");
						var itemName = 'item' + data.items[x].itemId;
						hr.attr('id', itemName);
						hr.attr('itemId', data.items[x].itemId);
						hr.attr('siteId', data.items[x].siteId);
						$("#content").append(hr);

						$(hr).waypoint(function() {
							$('#content').attr('pendingMarks', parseInt($('#content').attr('pendingMarks')) + 1);

						    id = $(this).attr('itemId');
						    //should move this into the complete() function callback
						    decreaseCount($(this).attr('siteId'));
						    //
							$.post("markItem.php",
							{
								itemId:id,
								action:'read'
							}, function() {
								$('#content').attr('pendingMarks', parseInt($('#content').attr('pendingMarks')) - 1);
							});
						}, { context: '.contents', triggerOnce: true });
					}

					//next item set loader waypoint
					var nextPageDiv = $("<div>").text('The next items will load when this hits the top of the window...');
					nextPageDiv.attr('id', 'nextPageDiv');
					$("#content").append(nextPageDiv);
					$('#nextPageDiv').waypoint(function() {
						window.setTimeout(nextPage, 100);
					}, { context: '.contents', triggerOnce: true });

					//padding at the bottom to enable the HR of the last item to hit the top of the screen and trigger it being read
					var footerDiv = $("<div>").css('height','100%');
					footerDiv.attr('id', 'footerDiv');
					$("#content").append(footerDiv);
				});
		 	}

		 	function disableWayPoints()
		 	{
		 		$('#content hr').each( function(index, element) {
		 			$(this).waypoint('destroy');
		 		});
		 		$('#nextPageDiv').waypoint('destroy');
		 	}

		 	function addSiteToList(siteName, siteId, siteUnread)
		 	{
				var div  = $("<div>");
				var link = $("<a>").text(siteName);
				link.attr('id', parseInt(siteId));
				link.attr('href', '#');
				link.click(function() {
					disableWayPoints();
					$('#content').attr('pendingMarks', 0);
					var id = parseInt($(this).attr('id'));
					loadItems(id);
				});

				var counter = $('<span>').text(' (' + siteUnread + ')');
				counter.attr('id', 'counter' + siteName);
				counter.attr('unreadCount', siteUnread);

				div.append(link);
				div.append(counter);
				div.append($("<br>"))

				$("#sites").append(div);

				//while we're here, may as well populate the search list too...
				var option = $("<option>").text(siteName);
				option.attr('value', siteId);
				$('#searchSiteList').append(option);
		 	}

		 	function loadSites()
		 	{
				$.post("getSites.php",
				function(data, status) {
					addSiteToList('All', -1, 0);

					var br  = $('<br>');
					var div = $('<div>').text('Subscriptions');
					$('#sites').append(br);
					$('#sites').append(br);
					$('#sites').append(div);

					var totalUnread = 0;
					data = decodeJSON(data);
					if (data && data.sites && data.sites.length)
					{
						for (var x = 0; x < data.sites.length; x++)
						{
							addSiteToList(data.sites[x].siteName, data.sites[x].siteId, data.sites[x].unread);
							totalUnread += parseInt(data.sites[x].unread);
						}
					}					
					$('#counterAll').attr('unreadCount', totalUnread);
					$('#counterAll').attr('lastItemId', data.lastItemId);
					$('#counterAll').text(' (' + totalUnread + ')');
				});
		 	}

		 	function search(term, siteId)
		 	{
		 		$("#searchResults").empty();

				$.post("search.php",
				{
					searchTerm : term,
					site       : siteId
				}, function(data) {
					data = decodeJSON(data);
					if (!data || !data.items || !data.items.length)
					{
						var div = $("<div>").text('No results returned.');
						$("#searchResults").append(div);
						return;
					}

					for (var x = 0; x < data.items.length; x++)
					{
						var div      = $("<div>");
						var linkText = data.items[x].site + ': ' + data.items[x].title;
						var showItem = $("<a>").text(linkText);

						div.append(showItem);
						$("#searchResults").append(div);

						if (data.items[x].localCopy)
						{
							var linkSup = $("<sup>").text('(local copy)');
							var localItem = $("<a>");
							localItem.append(linkSup);
							localItem.attr('href', data.items[x].localCopy);
							div.append(localItem);
						}

						showItem.attr('href', '#');
						showItem.attr('itemId', data.items[x].itemId);
						showItem.click( function() {
					 		$('#content').empty();
							var id = parseInt($(this).attr('itemId'));
							$.post("getItems.php",
							{
								itemId: id
							}, function(data) {
								data = decodeJSON(data);
								if (!data || !data.items || !data.items.length)
								{
									var div = $("<div>").text('Something went wrong.');
									$("#content").append(div);
									return;
								}

								for (var x = 0; x < data.items.length; x++)
								{
									var div = itemToDiv(data.items[x]);
									$("#content").append(div);
								}
							});
						});
					}
				});
		 	}

		 	function addSite(title, url)
		 	{
				$.post("addSite.php",
				{
					siteName:title,
					siteSource:url
				}, function(data) {
					data = decodeJSON(data);
					addSiteToList(data.site.name, data.site.id, data.site.unread);
					disableWayPoints();
					loadItems(data.site.id);
					var totalUnread = parseInt($('#counterAll').attr('unreadCount'));
					totalUnread += data.site.unread;
					$('#counterAll').attr('unreadCount', totalUnread);
					$('#counterAll').text(' (' + totalUnread + ')');
				});
		 	}

			$(document).ready(function() {
		 		$('#content').attr('currentSiteId', -2);
		 		$('#content').attr('pendingMarks', 0);

				loadSites();
				loadItems(-1);

				$("#clearMessages").click(function() {
					$('#messages').empty();
				});

				$("#addSite").click(function() {
					title = $("#siteName").val();
					url   = $("#siteSource").val();
					addSite(title, url);
				});

				$("#search").click(function() {
					searchTerm = $("#searchTerm").val();
					siteId = $("#searchSiteList").val();
					search(searchTerm, siteId)
				});

				$("#hideControlPanel").click(function() {
					$('#controlPanel').hide();
				});
				$("#showControlPanel").click(function() {
					$('#controlPanel').show();
				});

   			});
 			
		 </script> 
	</head>
	<body>
		<div id='siteList'>
			<div id='sites'>
			</div>
			<br />
			<br />
			<a id='showControlPanel' href='#'>Control Panel</a>
		</div>

		<div id='content' class='contents'>
		</div>

		<div id='controlPanel' class='tab'>
			<a id='hideControlPanel' class='hide' href="#"></a>
			<ul> 
				<li><a href="#manageSitesPane">Manage sites</a></li> 
				<li><a href="#messagePane">Messages</a></li> 
				<li><a href="#searchPane">Search</a></li> 
			</ul> 
			<div id='manageSitesPane'>
				<form method='post' id='addForm'>
					<fieldset>
						<legend>Add site</legend>
						<label for='siteName'>Name:</label>
						<input id='siteName' type='TEXT' placeholder='E.g., Engadget' size='100' /><br />
						<label for='siteSource'>Source:</label>
						<input id='siteSource' type='TEXT' placeholder='E.g., http://www.engadget.com/rss.xml' size='100' /><br />
						<a id='addSite' href='#'>Add</a>
					</fieldset>
				</form>
			</div>
			<div id='messagePane'>
				Messages: <a id='clearMessages' href='#'><sup>(clear all)</sup></a><br />
				<div id='messages'>
				</div>
			</div>
			<div id='searchPane'>
				<div>
					<select id='searchSiteList'>
					</select>
					&nbsp;for&nbsp;
					<input id='searchTerm' type='TEXT' placeholder='Search term' size='50' />
					<a id='search' href='#'>Search</a>
				</div>
				<div id='searchResults' class='searchResults'></div>
			</div>

			<script type="text/javascript"> 
				$("#controlPanel ul").idTabs(); 
			</script>
		</div>

	</body>
</html>