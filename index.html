<html>
    <head>
        <meta http-equiv="Cache-Control" content="no-cache">
        <meta http-equiv='Content-Type'  content='text/html; charset=utf-8'>
        <link href="arsse_feel.css" rel="stylesheet">
        <link href="arsse_look.css" rel="stylesheet">
        <!--[if lt IE 7]>
        <style type="text/css" media="screen">
            /* let the IE expressions commence */
            #sidebar
            {
                height: expression(document.body.clientHeight + "px");
            }
            #content
            {
                height: expression(document.body.clientHeight - (100 + 120 + (2 * 5)) + "px");
                width: expression(document.body.clientWidth - (200 + 300 + (2 * 5)) + "px");
            }
        </style>
        <![endif]-->
        <link href="controlPanel_feel.css" rel="stylesheet">
        <link href="controlPanel_look.css" rel="stylesheet">

        <script type="text/javascript" src="jquery-1.9.1.min.js"></script>
        <script type="text/javascript" src="waypoints.min.js"></script>
        <script type="text/javascript" src="jquery.idTabs.min.js"></script>

        <script type="text/javascript" src="search.js"></script>

        <script type="text/javascript"> 
            function decreaseCount(siteName)
            {
                for (var f = 0; f < 2; f++)
                {
                    var counter = $('#counter' + siteName);
                    var count   = counter.attr('unreadCount') - 1;
                    counter.attr('unreadCount', count);
                    counter.text(' (' + count + ')');
                    siteName = 'All';
                }
            }

            function nextPage()
            {
                //TODO: show a 'please wait' message here
                //TODO: count how many times this has been called. If it's taking longer than e.g., 10 seconds, then stop trying and show an error message
                var pending = parseInt($('#content').attr('pendingMarks'));
                if (pending > 0)
                    setTimeout(nextPage, 200);
                else
                    loadItems($('#content').attr('currentSiteId'));
            }

            function addStatusMessage(message)
            {
                if (!message)
                    return;

                var div = $('<div>').html(message);
                div.attr('class', 'statusMessage');
                $('#messages').prepend(div);
                $('#newMessageAlert').show();
            }

            function decodeJSON(data)
            {
                if (!data)
                    return null;

                data = jQuery.parseJSON(data);

                if (data.warning)
                    addStatusMessage(data.warning);

                if (!data.error)
                    return data;

                addStatusMessage(data.error);
                return null;
            }

            function makeTagSpan(selectBoxName, itemId, tagId, text)
            {
                //alert(selectBoxName + ':' + itemId + ':' + tagId + ':' + text);
                var tagSpan = $('<span>').text(text + ' ');
                tagSpan.attr('class',     'tag');
                tagSpan.attr('id',        'tagSpan' + itemId + "_" + tagId);
                tagSpan.attr('tagId',     tagId);

                var hideButton  = $('<img>');
                hideButton.attr('src', 'delete.png');

                var hideTag     = $('<a>');
                hideTag.append(hideButton);
                hideTag.attr('href',      '#');
                hideTag.attr('itemId',    itemId);
                hideTag.attr('tagText',   text);
                hideTag.attr('tagId',     tagId);
                hideTag.attr('selectBox', selectBoxName);
                hideTag.click(function() {
                    var itemId    = $(this).attr('itemId');
                    var tagText   = $(this).attr('tagText');
                    var tagId     = $(this).attr('tagId');
                    var selectBox = $(this).attr('selectBox');
                    var selectDiv = $(selectBox).attr('tagsDivId');

                    $.post("changeItemTag.php",
                    {
                        action:  'remove',
                        item:    itemId,
                        tag:     tagId,
                        text:    tagText,
                        select:  selectBox,
                        div:     selectDiv
                    },
                    function(data, status) {
                        data = decodeJSON(data);
                        if (!data || !data.select) //failure handled by decodeJSON
                            return;

                        var option  = $("<option>").text(data.text);
                        option.attr('value', data.tag);
                        $('#tagSpan'+data.item+'_'+data.tag).remove();
                        $(data.select).append(option);
                    });                 
                });

                tagSpan.append(hideTag);
                return tagSpan;
            }

            function itemToDiv(item, index)
            {
                var itemIdValue = item.itemId; //sigh, something is nuking this value

                var div      = $("<div>");
                div.attr('class', 'contentItem');
                
                var title    = $("<a>").text(item.siteId + ': ' + item.title);
                title.attr('href', item.source);
                
                var when     = $("<b>").text(item.timestamp + "   ");

                var saveText = $("<sup>").text("[save destination page]");
                var saveLink = $("<a>").text("");
                saveLink.append(saveText);
                saveLink.attr('href', '#');
                saveLink.attr('class', 'saveLink');
                saveLink.attr('itemId', itemIdValue);
                saveLink.click( function() {
                    var id = parseInt($(this).attr('itemId'));
                    $.post("savePage.php",
                    {
                        itemId: id
                    }, function(data) {
                        data = decodeJSON(data);
                        if (data)
                            addStatusMessage(data.message);
                    });
                });

                var contents = $("<div>").html(item.contents);

                div.append(when);
                div.append(saveLink);
                div.append($("<br>"));
                div.append(title);
                div.append($("<br>"));
                div.append(contents);
                div.append($("<br>"));

                //tags
                var tagsDiv    = $("<div>");
                var tagSelect = $("<select>");

                tagsDiv.attr('id', 'tagsDiv' + index);

                tagSelect.attr('id', 'tagSelect' + index);
                tagSelect.attr('itemId', itemIdValue);
                tagSelect.attr('tagsDivId', '#tagsDiv' + index);
                tagSelect.change(function() {
                    //oh there has to be a better way of doing this...
                    var tagId = $(this).val();
                    if (tagId == -1)
                        return;

                    var elementName = '#' + $(this).attr('id');
                    var tagText     = $(elementName+' option:selected').text();
                    var tagsDivId   = $(this).attr('tagsDivId');

                    $.post("changeItemTag.php",
                    {
                        action:  'add',
                        item:    itemIdValue,
                        tag:     tagId,
                        text:    tagText,
                        select:  elementName,
                        div:     tagsDivId
                    },
                    function(data, status) {
                        data = decodeJSON(data);
                        if (!data || !data.select) //failure handled by decodeJSON
                            return;

                        $(data.select+" option[value='"+data.tag+"']").remove();
                        $(data.div).append(makeTagSpan(data.select, data.item, data.tag, data.text));
                    });
                });

                tagsDiv.append(tagSelect);
                tagsDiv.append("&nbsp;");
                div.append(tagsDiv);

                //remove tags from the select list if they've already been applied to the item and make tag spans out of them
                var noShow = new Array(); //array of tags not to display in the list
                if (item.tags)
                {
                    for (var x = 0; x < item.tags.length; x++)
                    {
                        tagsDiv.append(makeTagSpan("#tagSelect" + index, itemIdValue, item.tags[x].tagId, item.tags[x].name));
                        tagsDiv.append("&nbsp;");
                        noShow.push(parseInt(item.tags[x].tagId));
                    }
                }
                tagSelect.attr('noShow', noShow);

                return div;         
            }

            function loadItems(siteId)
            {
                currentSiteId = $('#content').attr('currentSiteId');
                $('#content').empty();

                $('#content').attr('currentSiteId', siteId);
                lastItemId = $('#counterAll').attr('lastItemId');

                $('#content').attr('itemCount', 0);

                $.post("getItems.php",
                {
                    site       : siteId,
                    lastId     : lastItemId,
                    maxItems   : 10,
                },
                function(data, status) {
                    data = decodeJSON(data);
                    if (!data || !data.items || !data.items.length)
                    {
                        var div = $("<div>").text('Nothing to see here.');
                        $("#content").append(div);
                        return;
                    }

                    for (var x = 0; x < data.items.length; x++)
                    {
                        var div      = itemToDiv(data.items[x], x);
                        $("#content").append(div);

                        var hr       = $("<hr>");
                        var itemName = 'item' + data.items[x].itemId;
                        hr.attr('id', itemName);
                        hr.attr('itemId', data.items[x].itemId);
                        hr.attr('siteId', data.items[x].siteId);
                        $("#content").append(hr);

                        $(hr).waypoint(function() {
                            $('#content').attr('pendingMarks', parseInt($('#content').attr('pendingMarks')) + 1);

                            id = $(this).attr('itemId');
                            //should move this into the complete() function callback
                            decreaseCount($(this).attr('siteId'));
                            //
                            $.post("markItem.php",
                            {
                                itemId:id,
                                action:'read'
                            }, function() {
                                $('#content').attr('pendingMarks', parseInt($('#content').attr('pendingMarks')) - 1);
                            });
                        }, { context: '.contents', triggerOnce: true });
                    }
    
                    $('#content').attr('itemCount', data.items.length);

                    //next item set loader waypoint
                    var nextPageDiv = $("<div>").text('The next items will load when this hits the top of the window...');
                    nextPageDiv.attr('id', 'nextPageDiv');
                    $("#content").append(nextPageDiv);
                    $('#nextPageDiv').waypoint(function() {
                        window.setTimeout(nextPage, 100);
                    }, { context: '.contents', triggerOnce: true });

                    //padding at the bottom to enable the HR of the last item to hit the top of the screen and trigger it being read
                    var footerDiv = $("<div>").css('height','100%');
                    footerDiv.attr('id', 'footerDiv');
                    $("#content").append(footerDiv);
                });
            }

            function disableWayPoints()
            {
                $('#content hr').each( function(index, element) {
                    $(this).waypoint('destroy');
                });
                $('#nextPageDiv').waypoint('destroy');
            }

            function addSiteToList(siteName, siteId, siteUnread)
            {
                var div  = $("<div>");
                var link = $("<a>").text(siteName);
                link.attr('id', parseInt(siteId));
                link.attr('href', '#');
                link.click(function() {
                    disableWayPoints();
                    $('#content').attr('pendingMarks', 0);
                    var id = parseInt($(this).attr('id'));
                    loadItems(id);
                });

                var counter = $('<span>').text(' (' + siteUnread + ')');
                counter.attr('id', 'counter' + siteName);
                counter.attr('unreadCount', siteUnread);

                div.append(link);
                div.append(counter);
                div.append($("<br>"))

                $("#sites").append(div);

                //while we're here, may as well populate the search list too...
                var option = $("<option>").text(siteName);
                option.attr('value', siteId);
                $('#searchSiteList').append(option);
            }

            function loadSites()
            {
                $.post("getSites.php",
                function(data, status) {
                    addSiteToList('All', -1, 0);

                    var br  = $('<br>');
                    var div = $('<div>').text('Subscriptions');
                    $('#sites').append(br);
                    $('#sites').append(br);
                    $('#sites').append(div);

                    var totalUnread = 0;
                    data = decodeJSON(data);
                    if (data && data.sites && data.sites.length)
                    {
                        for (var x = 0; x < data.sites.length; x++)
                        {
                            addSiteToList(data.sites[x].siteName, data.sites[x].siteId, data.sites[x].unread);
                            totalUnread += parseInt(data.sites[x].unread);
                        }
                    }                   
                    $('#counterAll').attr('unreadCount', totalUnread);
                    $('#counterAll').attr('lastItemId', data.lastItemId);
                    $('#counterAll').text(' (' + totalUnread + ')');
                });
            }

            function addSite(title, url)
            {
                $.post("addSite.php",
                {
                    siteName:title,
                    siteSource:url
                }, function(data) {
                    data = decodeJSON(data);
                    addSiteToList(data.site.name, data.site.id, data.site.unread);
                    disableWayPoints();
                    loadItems(data.site.id);
                    var totalUnread = parseInt($('#counterAll').attr('unreadCount'));
                    totalUnread += data.site.unread;
                    $('#counterAll').attr('unreadCount', totalUnread);
                    $('#counterAll').text(' (' + totalUnread + ')');
                });
            }

            function addTag(tagName)
            {
                $.post("addTag.php",
                {
                    name: tagName
                }, function(data) {
                    data = decodeJSON(data);
                    if (!data)
                        return;

                    loadTags();
                });
            }

            function removeTag(tagId)
            {
                $.post("removeTag.php",
                {
                    id: tagId
                }, function(data) {
                    data = decodeJSON(data);
                    if (!data)
                        return;

                    loadTags();
                    $("span").each(function(index) {
                        var tag = $(this).attr('tagId');
                        if (tag && parseInt(tag) == parseInt(tagId))
                            $(this).remove();
                    });
                });
            }

            function contains(vector, value)
            {
                var i = vector.length;
                while (i--)
                    if (vector[i] === value)
                        return true;
                return false;
            }

            function loadTags()
            {
                $.post("getTags.php",
                {
                }, function(data) {
                    data = decodeJSON(data);
                    if (!data.tags)
                        return;
    
                    var selects = new Array();
                    selects.push('#searchTagList');
                    selects.push('#availableTags');
                    contentCount = parseInt($('#content').attr('itemCount'));
                    for (var item = 0; item < contentCount; item++)
                        selects.push('#tagSelect' + item);

                    for (var item = 0; item < selects.length; item++)
                    {
                        $(selects[item]).empty();

                        if (item == 0 || item > 1)
                        {
                            var text = (item == 0) ? 'any tag' : 'Select tag to add';
                            var option = $("<option>").text(text);
                            option.attr('value', -1);
                            $(selects[item]).append(option);
                        }
                        
                        var noShow = $(selects[item]).attr('noShow');
                        for (var x = 0; x < data.tags.length; x++)
                        {
                            if (!noShow || !contains(noShow, data.tags[x].id))
                            {
                                var option = $("<option>").text(data.tags[x].name);
                                option.attr('value', data.tags[x].id);
                                $(selects[item]).append(option);
                            }
                        }
                    }
                });
            }

            function startSearch()
            {
                searchTerm = $("#searchTerm").val();
                siteId     = $("#searchSiteList").val();
                tagId      = $("#searchTagList").val();
                search(searchTerm, siteId, tagId);
            }

            $(document).ready(function() {
                $('#content').attr('currentSiteId', -2);
                $('#content').attr('pendingMarks', 0);

                loadSites();
                loadItems(-1);

                $("#clearMessages").click(function() {
                    $('#messages').empty();
                    $("#newMessageAlert").hide();
                });

                $("#addSite").click(function() {
                    title = $("#siteName").val();
                    url   = $("#siteSource").val();
                    addSite(title, url);
                });

                $("#search").click(startSearch);

                $("#hideControlPanel").click(function() {
                    $('#controlPanel').hide();
                });
                $("#showControlPanel").click(function() {
                    $('#controlPanel').toggle();
                });

                $("#newMessageAlert").hide();
                $("#newMessageAlert").click(function() {
                    $("#controlPanel").show();
                    $("a","ul").removeClass("selected") 
                    .filter("[href='#messagePane']","ul").addClass("selected"); 
                    $("#manageSitesPane").hide();
                    $("#searchPane").hide();
                    $("#messagePane").show();
                    $("#newMessageAlert").hide();
                });

                $("#messagePane").click(function() {
                    $("#newMessageAlert").hide();
                });

                $("#addTagButton").click(function() {
                    var tagName = $("#addTagName").val();
                    addTag(tagName);
                });
                $("#removeTagButton").click(function() {
                    var tagId = $("#availableTags").val();
                    removeTag(tagId);
                });

                $("#controlPanel").hide();

                setTimeout(loadTags, 300);
            });
            
         </script> 
    </head>
    <body>
        <div id='siteList'>
            <div id='sites'>
            </div>
            <br />
            <br />
            <a id='showControlPanel' href='#'>Control Panel</a><img id='newMessageAlert' src='star.png' title='New message(s)' />
        </div>

        <div id='content' class='contents'>
        </div>

        <div id='controlPanel' class='tab'>
            <a id='hideControlPanel' class='hide' href="#"></a>
            <ul> 
                <li><a href="#manageSitesPane">Manage sites</a></li> 
                <li><a href="#manageTagsPane">Manage Tags</a></li> 
                <li><a href="#messagePane">Messages</a></li> 
                <li><a href="#searchPane">Search</a></li> 
            </ul> 
            <div id='manageSitesPane'>
                <form method='post' id='addForm'>
                    <fieldset>
                        <legend>Add site</legend>
                        <label for='siteName'>Name:</label>
                        <input id='siteName' type='TEXT' placeholder='E.g., Engadget' size='100' /><br />
                        <label for='siteSource'>Source:</label>
                        <input id='siteSource' type='TEXT' placeholder='E.g., http://www.engadget.com/rss.xml' size='100' /><br />
                        <a id='addSite' href='#'>Add</a>
                    </fieldset>
                </form>
            </div>
            <div id='manageTagsPane'>
                <form method='post' id='addTagForm'>
                    <fieldset>
                        <legend>Add tag</legend>
                        <label for='addTagName'>Name:</label>
                        <input id='addTagName' type='TEXT' placeholder='E.g., Technology, Cooking, etc.' size='50' />
                        <a id='addTagButton' href='#'>Add</a>
                    </fieldset>
                </form>
                <form method='post' id='removeTagForm'>
                    <fieldset>
                        <legend>Remove tag</legend>
                        <select id='availableTags'>
                        </select>
                        <a id='removeTagButton' href='#'>Remove</a>
                    </fieldset>
                </form>
            </div>
            <div id='messagePane'>
                Messages: <a id='clearMessages' href='#'><sup>(clear all)</sup></a><br />
                <div id='messages'>
                </div>
            </div>
            <div id='searchPane'>
                <div>
                    <select id='searchSiteList'>
                    </select>
                    &nbsp;marked with&nbsp;
                    <select id='searchTagList'>
                    </select>
                    &nbsp;for&nbsp;
                    <input id='searchTerm' type='TEXT' placeholder='E.g., title:android body:python' size='50' />
                    <!-- TODO: add tag searching here -->
                    <a id='search' href='#'>Search</a>
                </div>
                <div id='searchResults' class='searchResults'></div>
            </div>

            <script type="text/javascript"> 
                $("#controlPanel ul").idTabs(function(id, list, set) { 
                    if (id == '#messagePane')
                        $("#newMessageAlert").hide();
                    return true;
                });
            </script>
        </div>

        <script>
            $("#searchTerm").keypress(function(event) {
                if (event.which == 13)
                    startSearch();
            });
        </script>

    </body>
</html>